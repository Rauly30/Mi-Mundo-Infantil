{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Profesor - Mi Mundo Infantil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/paneles-style.css' %}">
</head>
<body>
    <div class="dashboard d-flex">
        <!-- Sidebar mejorado -->
        <nav class="sidebar">
            <div class="logo">
                <img src="{% static 'img/logo.png' %}" alt="Logo Mi Mundo Infantil">
                <h2 class="h5 mb-0 ms-2">Mi Mundo Infantil</h2>
            </div>
            
            <!-- Información del aula asignada -->
            <div class="classroom-info mb-4">
                <div class="classroom-card">
                    <div class="classroom-header">
                        <i class="fas fa-school"></i>
                        <span>Mi Aula</span>
                    </div>
                    <div class="classroom-details">
                        {% if profesor.aula_set.first %}
                        <h6>{{ profesor.aula_set.first.nombre }}</h6>
                        <small>{{ profesor.aula_set.first.nivel }} - {{ profesor.aula_set.first.estudiantes.count }} estudiantes</small>
                        {% else %}
                        <h6>Sin aula asignada</h6>
                        <small>Contacte al director</small>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Búsqueda rápida -->
            <div class="search-global mb-4">
                <div class="input-group">
                    <input type="text" id="quickSearch" class="form-control" placeholder="Buscar estudiante...">
                    <button class="btn btn-outline-light" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <ul class="nav-links list-unstyled">
                <li class="nav-item mb-2" data-section="dashboard">
                    <a href="#" class="nav-link text-white d-flex align-items-center">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item mb-2" data-section="estudiantes">
                    <a href="#" class="nav-link text-white d-flex align-items-center">
                        <i class="fas fa-users me-2"></i> Mis Estudiantes
                        <span class="badge bg-secondary ms-auto">{{ estudiantes.count }}</span>
                    </a>
                </li>
                <li class="nav-item mb-2" data-section="boletines">
                    <a href="#" class="nav-link text-white d-flex align-items-center">
                        <i class="fas fa-clipboard-list me-2"></i> Boletines
                        <span class="badge bg-info ms-auto">{{ boletines.count }}</span>
                    </a>
                </li>
                <li class="nav-item mb-2" data-section="evaluaciones">
                    <a href="#" class="nav-link text-white d-flex align-items-center">
                        <i class="fas fa-tasks me-2"></i> Evaluaciones
                    </a>
                </li>
                <li class="nav-item mb-2" data-section="comentarios">
                    <a href="#" class="nav-link text-white d-flex align-items-center">
                        <i class="fas fa-comments me-2"></i> Comentarios
                    </a>
                </li>
                <li class="nav-item mb-2" data-section="eventos">
                    <a href="#" class="nav-link text-white d-flex align-items-center">
                        <i class="fas fa-calendar me-2"></i> Eventos
                    </a>
                </li>
                <li class="nav-item mb-2" data-section="reportes">
                    <a href="#" class="nav-link text-white d-flex align-items-center">
                        <i class="fas fa-chart-bar me-2"></i> Reportes
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-footer mt-auto">
                <div class="user-info mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chalkboard-teacher fs-4 me-2"></i>
                        <div>
                            <small class="text-light">Profesor</small>
                            <div class="fw-bold">{{ profesor.nombre }} {{ profesor.apellido }}</div>
                            <small class="text-light">{{ profesor.especialidad }}</small>
                        </div>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#userSettingsModal">
                        <i class="fas fa-cog me-1"></i> Configuración
                    </button>
                    <a href="{% url 'logout' %}" class="btn btn-danger btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i> Cerrar Sesión
                    </a>
                </div>
            </div>
        </nav>

        <!-- Contenido principal -->
        <main class="content flex-grow-1">
            <!-- Header -->
            <header class="content-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-1">
                                <li class="breadcrumb-item"><a href="#">Inicio</a></li>
                                <li class="breadcrumb-item active" id="currentSection">Dashboard</li>
                            </ol>
                        </nav>
                        <h1 class="h3 mb-0" id="sectionTitle">Dashboard del Profesor</h1>
                    </div>
                    <div class="header-actions">
                        <div class="dropdown">
                            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-plus me-1"></i> Nuevo
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#agregarBoletinModal">
                                    <i class="fas fa-clipboard-list me-2"></i> Boletín
                                </a></li>
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#agregarComentarioModal">
                                    <i class="fas fa-comment me-2"></i> Comentario
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Mensajes -->
            {% if messages %}
            <div class="alert-container">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                    <i class="fas fa-info-circle me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Dashboard -->
            <div id="dashboard" class="content-section">
                <!-- Estadísticas rápidas -->
                <div class="row g-4 mb-4">
                    <div class="col-xl-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-icon bg-primary">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stats-content">
                                <h3>{{ estudiantes.count }}</h3>
                                <p>Estudiantes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-icon bg-success">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="stats-content">
                                <h3>{{ boletines.count }}</h3>
                                <p>Boletines</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-icon bg-info">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="stats-content">
                                <h3>{{ comentarios_estudiantes.count|add:comentarios_evaluaciones.count }}</h3>
                                <p>Comentarios</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stats-card">
                            <div class="stats-icon bg-warning">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="stats-content">
                                <h3>{{ evaluaciones.count }}</h3>
                                <p>Evaluaciones</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen del aula -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Rendimiento General del Aula
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="performance-overview">
                                    {% if boletines %}
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="performance-metric">
                                                <div class="metric-value text-success">
                                                    {% for boletin in boletines %}
                                                        {% if boletin.calificacion >= 16 %}
                                                            {% if forloop.first %}1{% else %}{{ forloop.counter0|add:1 }}{% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <div class="metric-label">Excelente</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="performance-metric">
                                                <div class="metric-value text-info">
                                                    {% for boletin in boletines %}
                                                        {% if boletin.calificacion >= 12 and boletin.calificacion < 16 %}
                                                            {% if forloop.first %}1{% else %}{{ forloop.counter0|add:1 }}{% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <div class="metric-label">Bueno</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="performance-metric">
                                                <div class="metric-value text-warning">
                                                    {% for boletin in boletines %}
                                                        {% if boletin.calificacion >= 10 and boletin.calificacion < 12 %}
                                                            {% if forloop.first %}1{% else %}{{ forloop.counter0|add:1 }}{% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <div class="metric-label">Regular</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="performance-metric">
                                                <div class="metric-value text-danger">
                                                    {% for boletin in boletines %}
                                                        {% if boletin.calificacion < 10 %}
                                                            {% if forloop.first %}1{% else %}{{ forloop.counter0|add:1 }}{% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <div class="metric-label">Necesita Apoyo</div>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-4">
                                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                        <h6 class="text-muted">No hay datos de rendimiento</h6>
                                        <p class="text-muted">Comience agregando boletines para ver las estadísticas</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-clock me-2"></i>
                                    Actividades Recientes
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="activity-timeline">
                                    {% for boletin in boletines|slice:":3" %}
                                    <div class="activity-item">
                                        <div class="activity-icon bg-success">
                                            <i class="fas fa-clipboard-check"></i>
                                        </div>
                                        <div class="activity-content">
                                            <p class="mb-1">Boletín agregado</p>
                                            <small class="text-muted">{{ boletin.estudiante.nombre }} - {{ boletin.fecha|timesince }}</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% if not boletines %}
                                    <div class="text-center py-3">
                                        <i class="fas fa-history fa-2x text-muted mb-2"></i>
                                        <p class="text-muted mb-0">No hay actividad reciente</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accesos rápidos -->
                <div class="row g-4">
                    <div class="col-md-6 col-lg-3">
                        <div class="quick-action-card" data-bs-toggle="modal" data-bs-target="#agregarBoletinModal">
                            <div class="quick-action-icon">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <h6>Agregar Boletín</h6>
                            <p>Registrar nuevas calificaciones</p>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="quick-action-card" onclick="showSection('estudiantes')">
                            <div class="quick-action-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h6>Ver Estudiantes</h6>
                            <p>Gestionar información de estudiantes</p>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="quick-action-card" data-bs-toggle="modal" data-bs-target="#agregarComentarioModal">
                            <div class="quick-action-icon">
                                <i class="fas fa-comment-alt"></i>
                            </div>
                            <h6>Nuevo Comentario</h6>
                            <p>Agregar observaciones</p>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="quick-action-card" onclick="showSection('reportes')">
                            <div class="quick-action-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <h6>Ver Reportes</h6>
                            <p>Análisis y estadísticas</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Estudiantes Mejorada -->
            <div id="estudiantes" class="content-section" style="display: none;">
                <div class="section-header mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2>Mis Estudiantes</h2>
                            <p class="text-muted">Gestiona la información de tus estudiantes</p>
                        </div>
                    </div>
                </div>

                <!-- Filtros de estudiantes -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Buscar estudiante</label>
                                <div class="input-group">
                                    <input type="text" id="searchEstudiante" class="form-control" placeholder="Nombre del estudiante...">
                                    <button class="btn btn-outline-secondary" type="button">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ordenar por</label>
                                <select id="sortEstudiantes" class="form-select">
                                    <option value="nombre">Nombre A-Z</option>
                                    <option value="nombre_desc">Nombre Z-A</option>
                                    <option value="edad">Edad (menor a mayor)</option>
                                    <option value="edad_desc">Edad (mayor a menor)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button class="btn btn-outline-primary" id="resetFilters">
                                        <i class="fas fa-undo me-1"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid de estudiantes -->
                <div class="row" id="estudiantesGrid">
                    {% for estudiante in estudiantes %}
                    <div class="col-lg-6 col-xl-4 mb-4 estudiante-card" 
                         data-nombre="{{ estudiante.nombre|lower }} {{ estudiante.apellido|lower }}"
                         data-edad="{{ estudiante.edad }}">
                        <div class="card h-100 student-profile-card">
                            <div class="card-header bg-light">
                                <div class="d-flex align-items-center">
                                    <div class="student-avatar me-3">
                                        <i class="fas fa-user-graduate"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">{{ estudiante.nombre }} {{ estudiante.apellido }}</h6>
                                        <small class="text-muted">{{ estudiante.edad }} años</small>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" 
                                                   data-bs-target="#verEstudianteModal{{ estudiante.id }}">
                                                <i class="fas fa-eye me-2"></i> Ver perfil
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" 
                                                   onclick="agregarBoletinRapido(1)">
                                                <i class="fas fa-plus me-2"></i> Agregar boletín
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" 
                                                   onclick="agregarComentarioRapido(1)">
                                                <i class="fas fa-comment me-2"></i> Comentario
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="student-info">
                                    <div class="info-item">
                                        <i class="fas fa-birthday-cake text-muted me-2"></i>
                                        <span>{{ estudiante.fecha_nacimiento|date:"d/m/Y" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-layer-group text-muted me-2"></i>
                                        <span>{{ estudiante.nivel }}</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-user-friends text-muted me-2"></i>
                                        <span>{{ estudiante.representante.nombre }} {{ estudiante.representante.apellido }}</span>
                                    </div>
                                </div>
                                
                                <!-- Progreso académico -->
                                <div class="academic-progress mt-3">
                                    <h6 class="text-primary mb-2">Progreso Académico</h6>
                                    {% with estudiante.boletines.all as boletines_estudiante %}
                                    {% if boletines_estudiante %}
                                    <div class="progress-summary">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small>Promedio General</small>
                                            <small class="fw-bold">
                                                {% widthratio boletines_estudiante|length 1 100 as total %}
                                                {% for boletin in boletines_estudiante %}
                                                    {% if forloop.first %}
                                                        {% widthratio boletin.calificacion 1 1 as suma %}
                                                    {% else %}
                                                        {% widthratio suma|add:boletin.calificacion 1 1 as suma %}
                                                    {% endif %}
                                                {% endfor %}
                                                {% widthratio suma boletines_estudiante|length 1 %}/20
                                            </small>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-success" style="width: 50%"></div>
                                        </div>
                                        <small class="text-muted">{{ boletines_estudiante|length }} evaluaciones</small>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-2">
                                        <small class="text-muted">Sin evaluaciones</small>
                                    </div>
                                    {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary flex-fill" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#verEstudianteModal{{ estudiante.id }}">
                                        <i class="fas fa-eye me-1"></i> Ver
                                    </button>
                                    <button class="btn btn-sm btn-primary flex-fill" 
                                            onclick="agregarBoletinRapido('{{ estudiante.id }}')">
                                        <i class="fas fa-plus me-1"></i> Boletín
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Sección de Boletines Mejorada -->
            <div id="boletines" class="content-section" style="display: none;">
                <div class="section-header mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2>Gestión de Boletines</h2>
                            <p class="text-muted">Administra las calificaciones de tus estudiantes</p>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarBoletinModal">
                            <i class="fas fa-plus me-2"></i> Nuevo Boletín
                        </button>
                    </div>
                </div>

                <!-- Filtros de boletines -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Estudiante</label>
                                <select id="filterEstudianteBoletin" class="form-select">
                                    <option value="">Todos los estudiantes</option>
                                    {% for estudiante in estudiantes %}
                                    <option value="{{ estudiante.id }}">{{ estudiante.nombre }} {{ estudiante.apellido }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Periodo</label>
                                <select id="filterPeriodo" class="form-select">
                                    <option value="">Todos los periodos</option>
                                    <option value="Primer Trimestre">Primer Trimestre</option>
                                    <option value="Segundo Trimestre">Segundo Trimestre</option>
                                    <option value="Tercer Trimestre">Tercer Trimestre</option>
                                    <option value="Final">Final</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Asignatura</label>
                                <input type="text" id="filterAsignatura" class="form-control" placeholder="Filtrar por asignatura...">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button class="btn btn-outline-primary" id="applyBoletinFilters">
                                        <i class="fas fa-filter me-1"></i> Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de boletines mejorada -->
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Estudiante</th>
                                        <th>Periodo</th>
                                        <th>Asignatura</th>
                                        <th class="text-center">Calificación</th>
                                        <th>Fecha</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="boletinesTableBody">
                                    {% for boletin in boletines %}
                                    <tr class="boletin-row" 
                                        data-estudiante="{{ boletin.estudiante.id }}"
                                        data-periodo="{{ boletin.periodo }}"
                                        data-asignatura="{{ boletin.asignatura|lower }}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="student-avatar-sm me-2">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ boletin.estudiante.nombre }} {{ boletin.estudiante.apellido }}</div>
                                                    <small class="text-muted">{{ boletin.estudiante.edad }} años</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ boletin.periodo }}</span>
                                        </td>
                                        <td>
                                            <span class="fw-medium">{{ boletin.asignatura }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="grade-badge 
                                                {% if boletin.calificacion >= 16 %}grade-excellent
                                                {% elif boletin.calificacion >= 12 %}grade-good
                                                {% elif boletin.calificacion >= 10 %}grade-regular
                                                {% else %}grade-poor{% endif %}">
                                                {{ boletin.calificacion }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ boletin.fecha|date:"d/m/Y" }}</span>
                                            <br>
                                            <small class="text-muted">{{ boletin.fecha|time:"H:i" }}</small>
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#verBoletinModal{{ boletin.id }}"
                                                        title="Ver detalles">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editarBoletinModal{{ boletin.id }}"
                                                        title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="confirmarEliminacion('boletin', 1)"
                                                        title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Mensaje si no hay boletines -->
                {% if not boletines %}
                <div class="text-center py-5">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No hay boletines registrados</h5>
                    <p class="text-muted">Comience agregando el primer boletín de sus estudiantes</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarBoletinModal">
                        <i class="fas fa-plus me-2"></i> Agregar Primer Boletín
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Sección de Comentarios Mejorada -->
            <div id="comentarios" class="content-section" style="display: none;">
                <div class="section-header mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2>Gestión de Comentarios</h2>
                            <p class="text-muted">Administra observaciones sobre estudiantes y evaluaciones</p>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarComentarioModal">
                            <i class="fas fa-plus me-2"></i> Nuevo Comentario
                        </button>
                    </div>
                </div>

                <!-- Tabs para tipos de comentarios -->
                <ul class="nav nav-tabs mb-4" id="comentariosTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="estudiantes-tab" data-bs-toggle="tab" 
                                data-bs-target="#comentarios-estudiantes-tab" type="button" role="tab">
                            <i class="fas fa-user-graduate me-2"></i>
                            Comentarios de Estudiantes
                            <span class="badge bg-primary ms-2">{{ comentarios_estudiantes.count }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="evaluaciones-tab" data-bs-toggle="tab" 
                                data-bs-target="#comentarios-evaluaciones-tab" type="button" role="tab">
                            <i class="fas fa-tasks me-2"></i>
                            Comentarios de Evaluaciones
                            <span class="badge bg-info ms-2">{{ comentarios_evaluaciones.count }}</span>
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="comentariosTabContent">
                    <!-- Comentarios de Estudiantes -->
                    <div class="tab-pane fade show active" id="comentarios-estudiantes-tab" role="tabpanel">
                        <div class="row">
                            {% for comentario in comentarios_estudiantes %}
                            <div class="col-lg-6 mb-4">
                                <div class="card comment-card">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="student-avatar-sm me-2">
                                                    <i class="fas fa-user-graduate"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">{{ comentario.estudiante.nombre }} {{ comentario.estudiante.apellido }}</h6>
                                                    <small class="text-muted">{{ comentario.fecha|date:"d/m/Y H:i" }}</small>
                                                </div>
                                            </div>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" 
                                                           data-bs-target="#editCommentModalEstudiante{{ comentario.id }}">
                                                        <i class="fas fa-edit me-2"></i> Editar
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="#" 
                                                           onclick="confirmarEliminacion('comentario', 1)">
                                                        <i class="fas fa-trash me-2"></i> Eliminar
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <p class="comment-text">{{ comentario.texto }}</p>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <div class="text-center py-5">
                                    <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No hay comentarios de estudiantes</h5>
                                    <p class="text-muted">Agregue observaciones sobre el comportamiento y progreso de sus estudiantes</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Comentarios de Evaluaciones -->
                    <div class="tab-pane fade" id="comentarios-evaluaciones-tab" role="tabpanel">
                        <div class="row">
                            {% for comentario in comentarios_evaluaciones %}
                            <div class="col-lg-6 mb-4">
                                <div class="card comment-card">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-0">{{ comentario.evaluacion.plan|truncatechars:30 }}</h6>
                                                <small class="text-muted">{{ comentario.fecha|date:"d/m/Y H:i" }}</small>
                                            </div>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" 
                                                           data-bs-target="#editCommentModalEvaluacion{{ comentario.id }}">
                                                        <i class="fas fa-edit me-2"></i> Editar
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="#" 
                                                           onclick="confirmarEliminacion('comentario', '{{ comentario.id }}')">
                                                        <i class="fas fa-trash me-2"></i> Eliminar
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <p class="comment-text">{{ comentario.texto }}</p>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <div class="text-center py-5">
                                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No hay comentarios de evaluaciones</h5>
                                    <p class="text-muted">Agregue observaciones sobre las evaluaciones y planes de estudio</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Otras secciones (evaluaciones, eventos, reportes) -->
            <!-- Se mantienen similares pero con el mismo estilo mejorado -->
            
        </main>
    </div>

    <!-- Modales mejorados -->
    <!-- Modal para agregar boletín -->
    <div class="modal fade" id="agregarBoletinModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle me-2"></i>
                        Agregar Nuevo Boletín
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="{% url 'panel_profesor' %}" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="action" value="agregar_boletin">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="estudiante" class="form-label">Estudiante *</label>
                                <select id="estudiante" name="estudiante_id" class="form-select" required>
                                    <option value="">Seleccionar estudiante...</option>
                                    {% for estudiante in estudiantes %}
                                    <option value="{{ estudiante.id }}">{{ estudiante.nombre }} {{ estudiante.apellido }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Por favor seleccione un estudiante.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="periodo" class="form-label">Periodo *</label>
                                <select id="periodo" name="periodo" class="form-select" required>
                                    <option value="">Seleccionar periodo...</option>
                                    <option value="Primer Trimestre">Primer Trimestre</option>
                                    <option value="Segundo Trimestre">Segundo Trimestre</option>
                                    <option value="Tercer Trimestre">Tercer Trimestre</option>
                                    <option value="Final">Final</option>
                                </select>
                                <div class="invalid-feedback">Por favor seleccione un periodo.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="asignatura" class="form-label">Asignatura *</label>
                                <input type="text" id="asignatura" name="asignatura" class="form-control" 
                                       placeholder="Ej: Matemáticas, Lenguaje..." required>
                                <div class="invalid-feedback">Por favor ingrese la asignatura.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="calificacion" class="form-label">Calificación (0-20) *</label>
                                <input type="number" step="0.01" min="0" max="20" id="calificacion" 
                                       name="calificacion" class="form-control" required>
                                <div class="invalid-feedback">Por favor ingrese una calificación válida (0-20).</div>
                            </div>
                            <div class="col-12">
                                <label for="observaciones" class="form-label">Observaciones *</label>
                                <textarea id="observaciones" name="observaciones" class="form-control" 
                                          rows="4" placeholder="Escriba sus observaciones sobre el rendimiento del estudiante..." required></textarea>
                                <div class="invalid-feedback">Por favor ingrese las observaciones.</div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Guardar Boletín
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar comentario -->
    <div class="modal fade" id="agregarComentarioModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-comment-plus me-2"></i>
                        Agregar Comentario
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="{% url 'panel_profesor' %}" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="action" value="agregar_comentario">
                        
                        <!-- Tabs para tipo de comentario -->
                        <ul class="nav nav-pills mb-3" id="commentTypeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="student-comment-tab" data-bs-toggle="pill" 
                                        data-bs-target="#student-comment" type="button" role="tab">
                                    <i class="fas fa-user-graduate me-1"></i> Estudiante
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="evaluation-comment-tab" data-bs-toggle="pill" 
                                        data-bs-target="#evaluation-comment" type="button" role="tab">
                                    <i class="fas fa-tasks me-1"></i> Evaluación
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="commentTypeTabContent">
                            <div class="tab-pane fade show active" id="student-comment" role="tabpanel">
                                <div class="mb-3">
                                    <label for="studentId" class="form-label">Estudiante *</label>
                                    <select id="studentId" name="estudiante_id" class="form-select">
                                        <option value="">Seleccionar estudiante...</option>
                                        {% for estudiante in estudiantes %}
                                        <option value="{{ estudiante.id }}">{{ estudiante.nombre }} {{ estudiante.apellido }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="evaluation-comment" role="tabpanel">
                                <div class="mb-3">
                                    <label for="evaluationId" class="form-label">Evaluación *</label>
                                    <select id="evaluationId" name="evaluacion_id" class="form-select">
                                        <option value="">Seleccionar evaluación...</option>
                                        {% for evaluacion in evaluaciones %}
                                        <option value="{{ evaluacion.id }}">{{ evaluacion.aula.nombre }} - {{ evaluacion.plan|truncatechars:30 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="commentText" class="form-label">Comentario *</label>
                            <textarea id="commentText" name="texto" class="form-control" rows="4" 
                                      placeholder="Escriba su comentario u observación..." required></textarea>
                            <div class="invalid-feedback">Por favor ingrese el comentario.</div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-info">
                                <i class="fas fa-save me-1"></i> Guardar Comentario
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/panel-profesor.js' %}"></script>
</body>
</html>